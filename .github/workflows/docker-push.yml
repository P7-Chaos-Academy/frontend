name: Build and Push to Docker Hub

on:
  push:
    branches: 
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: p7-frontend
  DOCKER_REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      full-image: ${{ steps.image-tag.outputs.full_image }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Generate image tag
      id: image-tag
      run: |
        IMAGE_TAG=$(echo ${{ github.sha }} | cut -c1-8)
        echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "full_image=${{ vars.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ vars.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
        build-args: |
          NEXT_PUBLIC_API_BASE_URL=${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_BASE_URL=${{ vars.NEXT_PUBLIC_BASE_URL }}
          NEXT_PUBLIC_API_KEY=${{ secrets.NEXT_PUBLIC_API_KEY }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    

    - name: Checkout gitops repository
      uses: actions/checkout@v2
      with:
        repository: P7-Chaos-Academy/gitops
        token: ${{ secrets.GITOPS_REPO_TOKEN }}
        path: gitops-repo

    - name: Update Kubernetes manifest
      run: |
        cd gitops-repo
        sed -i "s|image: cgamel/p7-frontend:.*|image: ${{ steps.image-tag.outputs.full_image }}|g" frontend/deployment.yaml
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git add frontend/deployment.yaml
        git commit -m "Update frontend image to ${{ steps.image-tag.outputs.tag }}"
        git push

  deploy-info:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment info
      run: |
        echo "Docker image has been built and pushed successfully!"
        echo "Image tag: ${{ needs.build-and-push.outputs.image-tag }}"
        echo "Full image: ${{ needs.build-and-push.outputs.full-image }}"
        echo ""
        echo "To run the container locally:"
        echo "docker run -p 3000:3000 \\"
        echo "  -e NEXT_PUBLIC_API_BASE_URL=http://localhost:8080 \\"
        echo "  -e NEXT_PUBLIC_BASE_URL=http://localhost:3000 \\"
        echo "  -e NEXT_PUBLIC_API_KEY=<your-api-key> \\"
        echo "  ${{ needs.build-and-push.outputs.full-image }}"