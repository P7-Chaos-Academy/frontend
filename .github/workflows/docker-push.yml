name: Prod Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/build.yml@main
    with:
      language: node
      node_version: '20'

  containerize:
    needs: build
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/containerize.yml@main
    with:
      image_name: p7-frontend
      platforms: linux/amd64
      build_args: |
        NEXT_PUBLIC_API_BASE_URL=${{ vars.NEXT_PUBLIC_API_BASE_URL }}
        NEXT_PUBLIC_BASE_URL=${{ vars.NEXT_PUBLIC_BASE_URL }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      BUILD_SECRETS: |
        NEXT_PUBLIC_API_KEY=${{ secrets.NEXT_PUBLIC_API_KEY }}

  update-gitops:
    needs: containerize
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/manifest-update.yml@main
    with:
      gitops_repo: P7-Chaos-Academy/gitops
      manifest_path: frontend/deployment.yaml
      image_pattern: 'image: cgamel/p7-frontend:.*'
      new_image: ${{ needs.containerize.outputs.full_image }}
      commit_message: 'Update frontend image to ${{ needs.containerize.outputs.image_tag }}'
    secrets:
      GITOPS_REPO_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN }}
